let api,tab;class Tab{constructor(t){this.action=[this.Schedule,this.Mark,this.ChangePass,this.Logout],this.current="",this.menu=["Schedule","Mark","Password","Logout"],this.api=new API(t,this)}HOME(t){loginSuccess(),Menu.html(tag("div",{class:["user","flex"]},tag("img",{src:"/assets/img/user.png"})+tag("p",{},t.split(" | ")[1]))+tag("ul",{class:["menu","flex"]},function(t){return t.map((t=>{var e,a=tag("span",{},t),s=tag("img",{class:"icon",src:(e=t,`./assets/img/${e}.png`)});return tag("li",{class:"itemMenu",id:t},s+a)})).join("")}(this.menu)));for(var e=0;e<this.menu.length;e++)$("#"+this.menu[e]).click(this.action[e]);return setTimeout(doneHome,450)}ChangePass(){fadeUp(),setTimeout((function(){var e=tag("h2",{class:"textCenter"},"Change Password"),a=tag("input",{type:"password",id:"pwOld",required:!0,value:tab.api.info.pass}),s=tag("label",{for:"pwOld"},"Mật khẩu hiện tại"),i=tag("div",{class:"box"},a+s),o=tag("input",{type:"password",id:"pw1",required:!0}),n=tag("label",{for:"pw1"},"Mật khẩu mới"),r=tag("div",{class:"box"},o+n),c=tag("input",{type:"checkbox",id:"check",checked:!1}),l=tag("label",{for:"check"},"hiển thị mật khẩu"),u=tag("button",{id:"change"},"Cập Nhật"),d=tag("div",{},i+r),h=tag("div",{class:["form","flex"]},d+c+l),p=tag("p",{id:"msg"}," ");DOM.html(e+h+p+u),$(document.body).on("keyup",(e=>"Enter"==e.key?t():null)),$("#check").change((function(t){$("#pw1").attr("type",this.checked?"text":"password"),$("#pwOld").attr("type",this.checked?"text":"password")})),$("#change").click(t),displayRender()}),1e3);const t=()=>{const t=$("#msg");if(t.html(""),""==pw1.value||pw1.value==tab.api.info.pass)return t.text("bạn chưa nhập mật khẩu mới...");tab.api.ChangePassRequest($("#pwOld").val(),pw1.value,(function(){if(4==this.readyState){var t=JSON.parse(this.responseText);t.success&&(tab.api.info.pass=pw1.value,tab.api.saveInfo()),console.log(),e(t.msg,t.success)}}))},e=(e,a)=>{$(document.body).off("keyup",(e=>"Enter"==e.key?t():null)),setContentModal("Status",e),$("#pwOld").val(tab.api.info.pass),$("button").click(tab.ChangePass)}}Mark(){if(fade(),tab.api.info.marks)return t(tab.api.info.marks);function t(t){tab.api.info.marks=t,DOM.html(tag("div",{style:"overflow: overlay;",id:"mark"},""));const i=$("#mark");for(var o=0;o<t.length;o++){const{subject:s,score:d,scoreChar:h,survey:p,codeDetail:g}=t[o],f=tag("div",{class:"info flex"},tag("span",{class:"mon"},s));var n="",r="",c=" ";d&&(r+=e(d),r+=e(h),n=d>4?"pass":"fail",tab.api.getDetail(g,(function(){if(4==this.readyState){const{sContent:t,sDetail:e}=JSON.parse(this.responseText),s=$("#"+g);$(".loading > .task",s).css("width","100%"),setTimeout((()=>{for(var i in $(".loading",s).remove(),e)s.append(a(t[i],e[i]))}),500)}})),c=tag("div",{class:"detail",id:g},'<div class="loading"><div class="bg-loading"></div><div class="task"></div></div>'));const v=p?tag("button",{class:"survey","data-PID":p.PID,"data-SID":p.SID,"data-classId":p.classId,"data-auth":p.auth,"data-YearStudy":p.YearStudy,"data-TermID":p.TermID},"auto Survey"):"";var l=tag("div",{class:"flex header"},f+r+v),u=tag("div",{class:"subject flex column "+n},l+c+tag("div",{class:"bg"}," "));i.append(u)}DOM.append(tag("div",{class:"total"},[tag("div",{},`Total: ${t.length}`),tag("div",{},`Pass: ${$(".pass").length}`),tag("div",{},`Fail: ${$(".fail").length}`)])),console.log("DONE"),$(".survey").click(s),displayRender()}function e(t){return t?tag("span",{class:"score"},t):""}function a(t,e){return tag("div",{class:""},tag("span",{},t)+tag("span",{},e.toFixed(1)))}function s(t){const e=t.target.attributes;if(e.length){let t={PID:e["data-pid"].nodeValue,SID:e["data-sid"].nodeValue,ClassId:e["data-classid"].nodeValue,Auth:e["data-auth"].nodeValue,YearStudy:e["data-yearstudy"].nodeValue,TermID:e["data-termid"].nodeValue,cookie:tab.api.info.cookie};tab.api.Survey(t,(function(){if(4==this.readyState){var t=JSON.parse(this.responseText);setContentModal("title",t.msg)}}))}}tab.api.getMark((function e(){if(4==this.readyState){const a=JSON.parse(this.responseText);if(tab.api.info.studyProgram=a.sProgram,tab.api.saveInfo(),a.success)return t(a.data);tab.api.getMark(e)}}))}Schedule(){fade(),tab.api.getSchedule(callbackSchedule)}Logout(){chrome.storage.local.remove(dataKey),window.location.href="popup.html"}}class API{constructor(t,e){this.tab=e,this.host="https://api-huflit.herokuapp.com/",this.info=t,this.callback=function(t){if(4==t.currentTarget.readyState){if(!t.currentTarget.responseText)return alert("request failed");const e=JSON.parse(t.currentTarget.responseText);e.success&&console.log(e)}},this.info.schedule&&(e.HOME(this.info.name),renderSchedule(this.info.schedule))}setAccount(t,e){return!(!t||!e)&&(this.info.user=t,this.info.pass=e,!0)}saveInfo(){console.log("save"),chrome.storage.local.set(this.info)}requestServer(t,e,a=this.callback){const s=new XMLHttpRequest;s.open("POST",this.host+t),s.onreadystatechange=a,s.setRequestHeader("Accept","*/*"),s.setRequestHeader("Accept-Language","vi,en;q=0.9,vi-VN;q=0.8"),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.send(e)}login(t){if(!this.info.user||!this.info.pass)return displayInputLogin();const e=formData({user:this.info.user,pass:this.info.pass});return this.requestServer("login",e,t)}checkCookie(t){if(!this.info.cookie)return this.login(callbackLogin);const e=formData({cookie:this.info.cookie});return this.requestServer("checkCookie",e,t)}getSchedule(t){const e=formData({cookie:this.info.cookie});return this.requestServer("GetSchedule",e,t)}ChangePassRequest(t,e,a){const s=formData({cookie:this.info.cookie,oldPass:t,newPass:e});return this.requestServer("ChangePass",s,a)}getMark(t=this.callback){const e=formData({cookie:this.info.cookie,studyProgram:this.info.studyProgram||""});return this.requestServer("GetMark",e,t)}getDetail(t,e=this.callback){const a=formData({cookie:this.info.cookie,codeDetail:t});return this.requestServer("GetDetail",a,e)}Survey(t,e=this.callback){const a=formData(t);return this.requestServer("SurveyTeacher",a,e)}}(async()=>{var t=await getDataFormStorage(dataKey);tab=new Tab(t),tab.api.checkCookie(LoginControl)})();
